<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–æ–ø–Ω–∏ —à–∞—Ä–∏–∫–∏</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #aee1f9, #f8faff);
    }

    .ball {
      position: absolute;
      border-radius: 50%;
      cursor: pointer;
      animation: popIn 0.2s ease-out;
    }

    @keyframes popIn {
      from { transform: scale(0.5); opacity: 0.3; }
      to { transform: scale(1); opacity: 1; }
    }

    #endScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      font-size: 20px;
      text-align: center;
      z-index: 1000;
    }

    input, button {
      font-size: 18px;
      padding: 8px 16px;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: white;
    }

    th, td {
      padding: 6px 12px;
      text-align: left;
    }

    thead {
      background: rgba(255, 255, 255, 0.2);
    }

    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.1);
    }

    #highScoresTable {
      margin-top: 20px;
      max-width: 600px;
    }
  </style>
</head>
<body>

<div id="endScreen">
  <div id="result"></div>
  <div id="nameInput">
    <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è:</p>
    <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è">
    <button onclick="saveScore()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
  </div>
  <div id="highScoresTable"></div>
</div>

<script>
  const API_URL = 'http://localhost:3000';

  let hit = 0;
  let missed = 0;
  let level = 1;
  let isPlaying = true;
  let spawnInterval = 1200;
  let spawnTimer;

  function spawnBall() {
    const ball = document.createElement('div');
    const size = Math.random() * 50 + 30;
    const x = Math.random() * (window.innerWidth - size);
    const y = Math.random() * (window.innerHeight - size);

    ball.classList.add('ball');
    ball.style.width = size + 'px';
    ball.style.height = size + 'px';
    ball.style.left = x + 'px';
    ball.style.top = y + 'px';
    ball.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;

    document.body.appendChild(ball);

    const timeout = setTimeout(() => {
      if (document.body.contains(ball)) {
        document.body.removeChild(ball);
        missed++;
        checkGameState();
      }
    }, 3000);

    ball.addEventListener('click', () => {
      clearTimeout(timeout);
      document.body.removeChild(ball);
      hit++;
      adjustDifficulty();
      checkGameState();
    });
  }

  function adjustDifficulty() {
    if (hit % 5 === 0 && spawnInterval > 300) {
      spawnInterval -= 100;
      restartSpawn();
    }
  }

  function checkGameState() {
    if (missed >= 5) {
      endGame();
    } else if (hit >= level * 20) {
      level++;
      missed = 0;
      restartSpawn();
    }
  }

  function restartSpawn() {
    clearInterval(spawnTimer);
    spawnTimer = setInterval(spawnBall, spawnInterval);
  }

  function endGame() {
    isPlaying = false;
    clearInterval(spawnTimer);
    document.querySelectorAll('.ball').forEach(b => b.remove());

    document.getElementById('result').innerText =
      `–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n–£—Ä–æ–≤–µ–Ω—å: ${level}, –ü–æ–π–º–∞–Ω–æ: ${hit}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${missed}`;
    document.getElementById('endScreen').style.display = 'flex';
    document.getElementById('nameInput').style.display = 'flex';
    document.getElementById('playerName').value = '';
  }

  async function saveScore() {
    const name = document.getElementById('playerName').value.trim();
    if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');

    const score = {
      name,
      level,
      hit,
      timestamp: Date.now()
    };

    try {
      const res = await fetch(`${API_URL}/scores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(score)
      });
      const scores = await res.json();
      showOnlineScores(scores);
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', err);
    }

    document.getElementById('nameInput').style.display = 'none';
  }

  async function fetchOnlineScores() {
    try {
      const res = await fetch(`${API_URL}/scores`);
      const scores = await res.json();
      showOnlineScores(scores);
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', err);
    }
  }

  function showOnlineScores(scores) {
    const rows = scores.map(s => `
      <tr>
        <td>${s.name}</td>
        <td>${s.level}</td>
        <td>${s.hit}</td>
        <td>${new Date(s.timestamp).toLocaleString()}</td>
      </tr>`).join('');

    document.getElementById('highScoresTable').innerHTML = `
      <h3>üåç –û–Ω–ª–∞–π–Ω —Ä–µ–∫–æ—Ä–¥—ã</h3>
      <table>
        <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–ü–æ–π–º–∞–Ω–æ</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
  restartSpawn();
  fetchOnlineScores();
</script>

</body>
</html>
